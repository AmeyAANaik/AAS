<div class="page">
  <div class="login-screen" *ngIf="!isLoggedIn">
    <div class="card">
      <h1>AAS Operations</h1>
      <p class="muted">Sign in to access live ERP data.</p>

      <label>
        Username
        <input type="text" [(ngModel)]="loginUsername" />
      </label>

      <label>
        Password
        <input type="password" [(ngModel)]="loginPassword" />
      </label>

      <button class="primary" (click)="login()">Login</button>
      <p class="status" *ngIf="loginStatus">{{ loginStatus }}</p>
    </div>
  </div>

  <div class="app-shell" *ngIf="isLoggedIn">
    <header class="topbar">
      <div>
        <h2>Live Operations</h2>
        <p class="muted">Signed in as {{ loggedInUser }}</p>
      </div>
      <div class="top-actions">
        <button class="ghost" (click)="loadReferenceData()">Refresh</button>
        <button class="ghost" (click)="logout()">Logout</button>
      </div>
    </header>

    <section class="section">
      <div class="section-header">
        <h3>Role view</h3>
      </div>
      <div class="role-tabs" *ngIf="canSwitchRoles; else roleLabel">
        <button class="ghost" [class.active]="currentRole === 'admin'" (click)="setRole('admin')">
          Admin
        </button>
        <button class="ghost" [class.active]="currentRole === 'vendor'" (click)="setRole('vendor')">
          Vendor
        </button>
        <button class="ghost" [class.active]="currentRole === 'shop'" (click)="setRole('shop')">
          Shop
        </button>
        <button class="ghost" [class.active]="currentRole === 'helper'" (click)="setRole('helper')">
          Helper
        </button>
      </div>
      <ng-template #roleLabel>
        <div class="role-chip">Current role: {{ currentRole | titlecase }}</div>
      </ng-template>
    </section>

    <section class="section">
      <div class="section-header">
        <h3>Overview</h3>
        <p class="muted">{{ dataStatus }}</p>
      </div>
      <div class="kpi-grid">
        <div class="kpi">
          <p class="kpi-title">Shops</p>
          <p class="kpi-value">{{ shops.length }}</p>
        </div>
        <div class="kpi">
          <p class="kpi-title">Items</p>
          <p class="kpi-value">{{ items.length }}</p>
        </div>
        <div class="kpi">
          <p class="kpi-title">Vendors</p>
          <p class="kpi-value">{{ vendors.length }}</p>
        </div>
        <div class="kpi">
          <p class="kpi-title">Categories</p>
          <p class="kpi-value">{{ categories.length }}</p>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'admin'">
      <div class="section-header">
        <h3>Seed master data</h3>
        <p class="muted">Create required masters if they are missing.</p>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            New shop (Customer)
            <input type="text" [(ngModel)]="newShopName" />
          </label>
          <label>
            New vendor (Supplier)
            <input type="text" [(ngModel)]="newVendorName" />
          </label>
          <label>
            New category (Item Group)
            <input type="text" [(ngModel)]="newCategoryName" />
          </label>
          <label>
            New item code
            <input type="text" [(ngModel)]="newItemCode" />
          </label>
          <label>
            New item name
            <input type="text" [(ngModel)]="newItemName" />
          </label>
          <label>
            Item group
            <select [(ngModel)]="newItemGroup">
              <option value="">All Item Groups</option>
              <option *ngFor="let category of categories" [value]="category.name">{{ category.name }}</option>
            </select>
          </label>
          <label>
            Vendor rate
            <input type="number" [(ngModel)]="newItemVendorRate" min="0" />
          </label>
          <label>
            Margin %
            <input type="number" [(ngModel)]="newItemMarginPercent" min="0" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="createShop()">Add Shop</button>
            <button class="ghost" (click)="createVendor()">Add Vendor</button>
          </div>
          <div class="form-actions">
            <button class="ghost" (click)="createCategory()">Add Category</button>
            <button class="ghost" (click)="createItem()">Add Item</button>
            <span class="status">{{ seedStatus }}</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'admin' || currentRole === 'shop'">
      <div class="section-header">
        <h3>Create order</h3>
        <p class="muted">Creates a Sales Order in ERPNext via mw.</p>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Shop (Customer)
            <select [(ngModel)]="orderCustomer">
              <option value="">Select shop</option>
              <option *ngFor="let shop of shops" [value]="shop.name">{{ shop.name }}</option>
            </select>
          </label>
          <label>
            Company
            <input type="text" [(ngModel)]="orderCompany" placeholder="AAS Core" />
          </label>
          <label>
            Order date
            <input type="date" [(ngModel)]="orderDate" />
          </label>
          <label>
            Delivery date
            <input type="date" [(ngModel)]="orderDeliveryDate" />
          </label>
          <label>
            Item
            <select [(ngModel)]="orderItemCode" (change)="onItemSelected()">
              <option value="">Select item</option>
              <option *ngFor="let item of items" [value]="item.name">{{ item.name }}</option>
            </select>
          </label>
          <label>
            Qty
            <input type="number" [(ngModel)]="orderQty" min="1" />
          </label>
          <label>
            Cost price
            <input type="number" [(ngModel)]="orderCostRate" min="0" />
          </label>
          <label>
            Margin %
            <input type="number" [(ngModel)]="orderMarginPercent" min="0" />
          </label>
          <label>
            Rate
            <input type="number" [(ngModel)]="orderRate" min="0" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="createOrder()">Create Order</button>
            <span class="status">{{ orderStatus }}</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'admin'">
      <div class="section-header">
        <h3>Assign vendor & status</h3>
        <p class="muted">Updates custom fields on Sales Order.</p>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Order
            <select [(ngModel)]="selectedOrderId">
              <option value="">Select order</option>
              <option *ngFor="let order of createdOrders" [value]="order.id">{{ order.id }}</option>
            </select>
          </label>
          <label>
            Vendor
            <select [(ngModel)]="selectedVendor">
              <option value="">Select vendor</option>
              <option *ngFor="let vendor of vendors" [value]="vendor.name">{{ vendor.name }}</option>
            </select>
          </label>
          <label>
            Status
            <select [(ngModel)]="selectedStatus">
              <option value="Accepted">Accepted</option>
              <option value="Preparing">Preparing</option>
              <option value="Ready">Ready</option>
              <option value="Delivered">Delivered</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="primary" (click)="assignVendor()">Assign Vendor</button>
            <button class="ghost" (click)="updateStatus()">Update Status</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'admin'">
      <div class="section-header">
        <h3>Invoice & payment</h3>
        <p class="muted">Creates Sales Invoice and Payment Entry.</p>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Order
            <select [(ngModel)]="selectedOrderId">
              <option value="">Select order</option>
              <option *ngFor="let order of createdOrders" [value]="order.id">{{ order.id }}</option>
            </select>
          </label>
          <label>
            Payment amount
            <input type="number" [(ngModel)]="paymentAmount" min="0" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="createInvoice()">Create Invoice</button>
            <button class="ghost" (click)="createPayment()">Record Payment</button>
          </div>
          <div class="status">{{ invoiceStatus }}</div>
          <div class="status">{{ paymentStatus }}</div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'admin'">
      <div class="section-header">
        <h3>Order filters</h3>
        <button class="ghost" (click)="downloadOrdersCsv()">Download CSV</button>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Shop
            <select [(ngModel)]="filterShop">
              <option value="">All</option>
              <option *ngFor="let shop of shops" [value]="shop.name">{{ shop.name }}</option>
            </select>
          </label>
          <label>
            Vendor
            <select [(ngModel)]="filterVendor">
              <option value="">All</option>
              <option *ngFor="let vendor of vendors" [value]="vendor.name">{{ vendor.name }}</option>
            </select>
          </label>
          <label>
            Status
            <select [(ngModel)]="filterStatus">
              <option value="">All</option>
              <option value="Accepted">Accepted</option>
              <option value="Preparing">Preparing</option>
              <option value="Ready">Ready</option>
              <option value="Delivered">Delivered</option>
            </select>
          </label>
          <label>
            From
            <input type="date" [(ngModel)]="filterFrom" />
          </label>
          <label>
            To
            <input type="date" [(ngModel)]="filterTo" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="loadOrders()">Apply filters</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'vendor'">
      <div class="section-header">
        <h3>Vendor orders</h3>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Vendor
            <select [(ngModel)]="vendorView">
              <option value="">Select vendor</option>
              <option *ngFor="let vendor of vendors" [value]="vendor.name">{{ vendor.name }}</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="primary" (click)="loadVendorOrders()">Load orders</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'shop'">
      <div class="section-header">
        <h3>Shop orders</h3>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Shop
            <select [(ngModel)]="shopView">
              <option value="">Select shop</option>
              <option *ngFor="let shop of shops" [value]="shop.name">{{ shop.name }}</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="primary" (click)="loadShopOrders()">Load orders</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'vendor'">
      <div class="section-header">
        <h3>Vendor reports</h3>
        <div class="top-actions">
          <button class="ghost" (click)="downloadVendorOrdersCsv()">Orders CSV</button>
          <button class="ghost" (click)="downloadVendorBillingCsv()">Billing CSV</button>
          <button class="ghost" (click)="downloadVendorPaymentsCsv()">Payments CSV</button>
        </div>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Vendor
            <select [(ngModel)]="vendorView">
              <option value="">Select vendor</option>
              <option *ngFor="let vendor of vendors" [value]="vendor.name">{{ vendor.name }}</option>
            </select>
          </label>
          <label>
            Month
            <input type="month" [(ngModel)]="reportMonth" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="loadVendorReports()">Load reports</button>
          </div>
        </div>
      </div>
      <div class="card">
        <table class="data-table" *ngIf="vendorReportOrders.length; else noVendorReportOrders">
          <thead>
            <tr>
              <th>Vendor</th>
              <th>Shop</th>
              <th>Orders</th>
              <th>Cost</th>
              <th>Margin</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of vendorReportOrders">
              <td>{{ row.vendor }}</td>
              <td>{{ row.shop }}</td>
              <td>{{ row.orders }}</td>
              <td>{{ row.cost_total || 0 }}</td>
              <td>{{ row.margin_total || 0 }}</td>
              <td>{{ row.total }}</td>
            </tr>
          </tbody>
        </table>
        <ng-template #noVendorReportOrders>
          <p class="muted">No vendor orders for the selected month.</p>
        </ng-template>
      </div>
      <div class="card grid-3">
        <div>
          <h4>Billing totals</h4>
          <ul class="list">
            <li *ngFor="let row of vendorReportBilling">
              {{ row.vendor }} — {{ row.total }} (Cost {{ row.cost_total || 0 }}, Margin {{ row.margin_total || 0 }})
            </li>
          </ul>
        </div>
        <div>
          <h4>Payment totals</h4>
          <ul class="list">
            <li *ngFor="let row of vendorReportPayments">{{ row.vendor }} — {{ row.total }}</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'shop'">
      <div class="section-header">
        <h3>Shop reports</h3>
        <div class="top-actions">
          <button class="ghost" (click)="downloadShopBillingCsv()">Billing CSV</button>
          <button class="ghost" (click)="downloadShopPaymentsCsv()">Payments CSV</button>
          <button class="ghost" (click)="downloadShopCategoryCsv()">Category CSV</button>
        </div>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Shop
            <select [(ngModel)]="shopView">
              <option value="">Select shop</option>
              <option *ngFor="let shop of shops" [value]="shop.name">{{ shop.name }}</option>
            </select>
          </label>
          <label>
            Month
            <input type="month" [(ngModel)]="reportMonth" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="loadShopReports()">Load reports</button>
          </div>
        </div>
      </div>
      <div class="card grid-3">
        <div>
          <h4>Billing totals</h4>
          <ul class="list">
            <li *ngFor="let row of shopReportBilling">
              {{ row.shop }} — {{ row.total }} (Cost {{ row.cost_total || 0 }}, Margin {{ row.margin_total || 0 }})
            </li>
          </ul>
        </div>
        <div>
          <h4>Payment totals</h4>
          <ul class="list">
            <li *ngFor="let row of shopReportPayments">{{ row.shop }} — {{ row.total }}</li>
          </ul>
        </div>
        <div>
          <h4>Category totals</h4>
          <ul class="list">
            <li *ngFor="let row of shopReportCategory">
              {{ row.category }} — {{ row.total }} (Cost {{ row.cost_total || 0 }}, Margin {{ row.margin_total || 0 }})
            </li>
          </ul>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'admin' || currentRole === 'shop'">
      <div class="section-header">
        <h3>Invoices</h3>
        <div class="top-actions">
          <button class="ghost" (click)="loadInvoices()">Refresh list</button>
          <button class="ghost" (click)="downloadInvoicesCsv()">Download CSV</button>
        </div>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Shop
            <select [(ngModel)]="shopView">
              <option value="">All shops</option>
              <option *ngFor="let shop of shops" [value]="shop.name">{{ shop.name }}</option>
            </select>
          </label>
          <label>
            From
            <input type="date" [(ngModel)]="filterFrom" />
          </label>
          <label>
            To
            <input type="date" [(ngModel)]="filterTo" />
          </label>
          <div class="form-actions">
            <button class="primary" (click)="loadInvoices()">Load invoices</button>
            <span class="status">{{ invoiceStatusMessage }}</span>
          </div>
        </div>
      </div>
      <div class="card">
        <table class="data-table" *ngIf="invoices.length; else noInvoices">
          <thead>
            <tr>
              <th>Invoice</th>
              <th>Customer</th>
              <th>Date</th>
              <th>Total</th>
              <th>Status</th>
              <th>PDF</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invoice of invoices">
              <td>{{ invoice.name }}</td>
              <td>{{ invoice.customer }}</td>
              <td>{{ invoice.posting_date }}</td>
              <td>{{ invoice.grand_total }}</td>
              <td>{{ invoice.status }}</td>
              <td>
                <button class="ghost" (click)="downloadInvoicePdf(invoice.name)">Download</button>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #noInvoices>
          <p class="muted">No invoices found for the selected filters.</p>
        </ng-template>
      </div>
    </section>

    <section class="section" *ngIf="currentRole === 'vendor' || currentRole === 'shop' || currentRole === 'helper'">
      <div class="section-header">
        <h3>Update order status</h3>
      </div>
      <div class="card form-card">
        <div class="form-grid">
          <label>
            Order
            <select [(ngModel)]="selectedOrderId">
              <option value="">Select order</option>
              <option *ngFor="let order of orders" [value]="order.name">{{ order.name }}</option>
            </select>
          </label>
          <label>
            Status
            <select [(ngModel)]="selectedStatus">
              <option value="Accepted">Accepted</option>
              <option value="Preparing">Preparing</option>
              <option value="Ready">Ready</option>
              <option value="Delivered">Delivered</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="primary" (click)="updateStatus()">Update Status</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h3>Recent orders (this session)</h3>
        <button class="ghost" (click)="downloadOrdersCsv()">Download CSV</button>
      </div>
      <div class="card">
        <table class="data-table" *ngIf="orders.length; else noOrders">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Status</th>
              <th>Vendor</th>
              <th>Cost</th>
              <th>Margin %</th>
              <th>Margin</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of orders">
              <td>{{ order.name }}</td>
              <td>{{ order.customer }}</td>
              <td>{{ order.aas_status || order.status }}</td>
              <td>{{ order.aas_vendor || '-' }}</td>
              <td>{{ order.aas_cost_total || 0 }}</td>
              <td>{{ order.aas_margin_percent || 0 }}</td>
              <td>{{ order.aas_margin_total || 0 }}</td>
              <td>{{ order.grand_total }}</td>
            </tr>
          </tbody>
        </table>
        <ng-template #noOrders>
          <p class="muted">No orders created yet.</p>
        </ng-template>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h3>Reference data</h3>
      </div>
      <div class="card grid-3">
        <div>
          <h4>Shops</h4>
          <ul class="list">
            <li *ngFor="let shop of shops">{{ shop.name }}</li>
          </ul>
        </div>
        <div>
          <h4>Items</h4>
          <ul class="list">
            <li *ngFor="let item of items">{{ item.name }}</li>
          </ul>
        </div>
        <div>
          <h4>Vendors</h4>
          <ul class="list">
            <li *ngFor="let vendor of vendors">{{ vendor.name }}</li>
          </ul>
        </div>
        <div>
          <h4>Categories</h4>
          <ul class="list">
            <li *ngFor="let category of categories">{{ category.name }}</li>
          </ul>
        </div>
      </div>
    </section>
  </div>
</div>
