<section class="dashboard">
  <app-page-header
    title="Admin dashboard"
    [subtitle]="'Read-only snapshot for ' + ((vm$ | async)?.snapshot?.periodLabel || 'current period')">
    <button mat-flat-button color="primary" routerLink="/orders">View orders</button>
    <button mat-stroked-button color="primary" routerLink="/bills">Bills & invoices</button>
  </app-page-header>

  <ng-container *ngIf="vm$ | async as vm">
    <div class="state" *ngIf="vm.loading">Loading dashboard snapshot...</div>
    <div class="state error" *ngIf="vm.error">{{ vm.error }}</div>

    <div class="kpi-grid" *ngIf="!vm.loading && vm.snapshot">
      <mat-card class="kpi-card">
        <div class="kpi-label">Tracked items</div>
        <div class="kpi-value">{{ vm.snapshot.stockSnapshot.totalItems }}</div>
        <div class="kpi-meta">Total qty {{ vm.snapshot.stockSnapshot.totalQuantity | number: '1.0-2' }}</div>
      </mat-card>
      <mat-card class="kpi-card">
        <div class="kpi-label">Invoices</div>
        <div class="kpi-value">{{ vm.snapshot.salesSummary.invoiceCount }}</div>
        <div class="kpi-meta">{{ vm.snapshot.salesSummary.dateRangeLabel }}</div>
      </mat-card>
      <mat-card class="kpi-card">
        <div class="kpi-label">Branches with dues</div>
        <div class="kpi-value">{{ vm.snapshot.billsByBranch.length }}</div>
        <div class="kpi-meta">Open invoice exposure</div>
      </mat-card>
      <mat-card class="kpi-card">
        <div class="kpi-label">Vendors with dues</div>
        <div class="kpi-value">{{ vm.snapshot.billsByVendor.length }}</div>
        <div class="kpi-meta">Payables tracking</div>
      </mat-card>
    </div>

    <div class="dashboard-grid" *ngIf="!vm.loading && vm.snapshot">
      <mat-card class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Order status summary</div>
            <div class="card-subtitle">Live snapshot by fulfillment state</div>
          </div>
        </div>
        <mat-card-content>
          <table mat-table [dataSource]="vm.snapshot.orderStatus" class="data-table pro-table">
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let row">
                <span [class]="getStatusPillClass(row.status)">{{ row.status }}</span>
              </td>
            </ng-container>
            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef>Orders</th>
              <td mat-cell *matCellDef="let row">{{ row.count }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="orderStatusColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: orderStatusColumns"></tr>
          </table>
          <p class="muted" *ngIf="!vm.snapshot.orderStatus.length">
            No orders found in this period. Create an order to see status totals here.
          </p>
        </mat-card-content>
      </mat-card>

      <mat-card class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Bills due per branch</div>
            <div class="card-subtitle">Outstanding branch liabilities</div>
          </div>
        </div>
        <mat-card-content>
          <table mat-table [dataSource]="vm.snapshot.billsByBranch" class="data-table pro-table">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Branch</th>
              <td mat-cell *matCellDef="let row">{{ row.name }}</td>
            </ng-container>
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Amount due</th>
              <td mat-cell *matCellDef="let row">{{ row.total | number: '1.0-2' }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="billingColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: billingColumns"></tr>
          </table>
          <p class="muted" *ngIf="!vm.snapshot.billsByBranch.length">
            No branch bills due. Invoices will appear once created.
          </p>
        </mat-card-content>
      </mat-card>

      <mat-card class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Bills due per vendor</div>
            <div class="card-subtitle">Open payables by supplier</div>
          </div>
        </div>
        <mat-card-content>
          <table mat-table [dataSource]="vm.snapshot.billsByVendor" class="data-table pro-table">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Vendor</th>
              <td mat-cell *matCellDef="let row">{{ row.name }}</td>
            </ng-container>
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Amount due</th>
              <td mat-cell *matCellDef="let row">{{ row.total | number: '1.0-2' }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="billingColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: billingColumns"></tr>
          </table>
          <p class="muted" *ngIf="!vm.snapshot.billsByVendor.length">
            No vendor bills due. Assign vendors on orders to track totals.
          </p>
        </mat-card-content>
      </mat-card>

      <mat-card class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Sales / revenue summary</div>
            <div class="card-subtitle">Period performance snapshot</div>
          </div>
        </div>
        <mat-card-content>
          <div class="metric">
            <div>
              <p class="metric-label">Invoices</p>
              <p class="metric-value">{{ vm.snapshot.salesSummary.invoiceCount }}</p>
            </div>
            <div>
              <p class="metric-label">Total revenue</p>
              <p class="metric-value">{{ vm.snapshot.salesSummary.totalRevenue | number: '1.0-2' }}</p>
            </div>
          </div>
          <p class="muted">Period: {{ vm.snapshot.salesSummary.dateRangeLabel }}</p>
        </mat-card-content>
      </mat-card>
    </div>
  </ng-container>
</section>
